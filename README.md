# adoctl

Azure DevOps decomposition outbox + writer CLI.

This tool is designed to take **agent-generated decompositions** (Features + User Stories) in a canonical JSON “bundle” format, validate them against **team policy** and **ADO-derived metadata**, then (eventually) bulk-create the work items in Azure DevOps safely.

## Quickstart

Assumes:

- conda `4.9.2`
- Python `3.8.5`

- Create conda env: `conda env create --offline -f environment.yml`
- Activate: `conda activate adoctl`
- Run: `python -m adoctl sync --help`

If you want an `adoctl` executable in the env:

- `pip install -e .`

## Repository Layout

### `adoctl/`

Python package for the CLI and supporting modules.

- `adoctl/cli/` — CLI entrypoints and argument parsing.
- `adoctl/ado_client/` — ADO REST client primitives (auth, HTTP, config models).
- `adoctl/sync/` — “sync” implementation (ADO → `config/generated/*`).
- `adoctl/config/` — repo path helpers and config composition utilities (will expand).
- `adoctl/util/` — small utilities (filesystem, formatting, etc.).

### `config/`

Layered configuration (do not mix responsibilities between layers).

- `config/policy/` — team governance rules (human-authored).
  - `link_policy.yaml` — allowed link types and hierarchy rules.
  - `standards.yaml` — naming/tagging conventions.
  - `field_policy.yaml` — allowed/required canonical fields by canonical type.
  - `field_map.yaml` — canonical field key -> ADO reference name mapping.
  - `wit_map.yaml` — canonical work item type -> ADO work item type mapping.
  - `kr_taxonomy.yaml` — KR taxonomy used for tags/governance.
- `config/generated/` — ADO-derived facts (generated by `adoctl sync`; never hand-edit).
  - `projects.yaml` — org projects snapshot.
  - `teams.yaml` — teams for the selected project.
  - `paths_area.yaml` — flattened Area paths.
  - `paths_iteration.yaml` — flattened Iteration paths.
  - `wit_contract.yaml` — work item type fields and metadata.
  - `_sync_state.yaml` — sync metadata (timestamps, version, sections).
- `config/local/` — local operator context for CLI UX.
  - `context.yaml` — selected org/project/team/current iteration used by the home screen and defaults.

### `schema/`

Machine-readable contracts.

- `schema/bundle.schema.json` — JSON Schema for the canonical outbox bundle format.

### `outbox/`

File-based workflow for bundles.

- `outbox/ready/` — agent drops bundles here.
- `outbox/validated/` — bundles that pass validation (future command).
- `outbox/failed/` — bundles that fail validation + reports (future command).
- `outbox/archived/` — bundles successfully written + audit ref (future command).

### `audit/`

Structured audit artifacts emitted by `adoctl write` (future).

### `logs/`

Local log output (future: structured logs + redaction).

### Root files

- `environment.yml` — conda environment (pinned to Python `3.8.5`).
- `pyproject.toml` — packaging + CLI script definition (`adoctl`).
- `specs.md` — system specification and intended behavior.
- `AGENTS.md` — engineering constraints and the canonical bundle contract.

## Typical Developer Workflow

1) Sync ADO metadata into generated configs:

- Set PAT in env: `export ADO_PAT="..."`
- Run sync:
  - `python -m adoctl sync --org-url "https://dev.azure.com/<ORG>" --project "<PROJECT>" --all`

Optional home/context UX:

- Run `python -m adoctl` (or `python -m adoctl home`) to open the home screen menu.
- Use `python -m adoctl context show` to view saved context.
- Use `python -m adoctl context set --team "<TEAM>"` to update context non-interactively.

Bootstrap WIT contracts from extracted JSON:

- Run `python -m adoctl bootstrap-wit-contracts --input data.json --out-dir config/generated`
- This writes:
  - `config/generated/wit_contract.yaml` (aggregate contract)
  - `config/generated/wit_contracts/*.yaml` (one contract per work item type)

Export effective agent contract:

- Run `python -m adoctl contract export --out config/generated/agent_contract.yaml`
- This writes a single contract snapshot composed from:
  - policy mappings (`config/policy/wit_map.yaml`, `config/policy/field_map.yaml`)
  - field policy (`config/policy/field_policy.yaml`)
  - generated ADO metadata (`config/generated/wit_contract.yaml`)
- Precedence rule:
  - any canonical field mapped to an ADO-required field in `wit_contract.yaml` is promoted into `field_policy.yaml.required_fields`.
  - `field_policy.yaml` can still be stricter by requiring additional canonical fields.

2) Validate outbox bundles (not implemented yet):

- Intended: schema → policy → ADO metadata validation; no ADO writes on failure.

3) Write work items (not implemented yet):

- Intended: `--dry-run` supported, create Features then User Stories, link via parent-child, audit always, fail fast.
